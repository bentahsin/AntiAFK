name: Java CI with Maven - Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Kodu Checkout Yap
        uses: actions/checkout@v4

      - name: JDK 17 Kurulumu
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Maven ile Tüm Modülleri Derle (Build)
        run: mvn -B clean package

      - name: Yayın Varlıklarını ZIP Olarak Arşivle
        id: zip_release
        run: |
          # Derlenmiş ana JAR dosyalarını bul (kaynak, javadoc ve original JAR'ları hariç)
          # Klasör isimleri büyük/küçük harf duyarlıdır!
          CORE_JAR=$(find AntiAFK-Core/target -name "AntiAFK-Core-*.jar" ! -name "original-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar")
          GEYSER_JAR=$(find AntiAFK-Geyser/target -name "AntiAFK-Geyser-*.jar" ! -name "original-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar")
          
          # ZIP dosyası için bir isim belirle
          ZIP_NAME="AntiAFK-${{ github.ref_name }}.zip"
          
          # -j bayrağı, dosyaları klasör yapısı olmadan doğrudan zip'in köküne ekler.
          zip -j $ZIP_NAME $CORE_JAR $GEYSER_JAR
          
          # Sonraki adımlarda kullanmak için zip dosyasının yolunu output olarak ayarla
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: GitHub Release Oluştur
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            AntiAFK'nın ${{ github.ref_name }} sürümüne hoş geldiniz!
            
            Bu sürüm, hem Java 8 destekli ana eklentiyi (`AntiAFK-Core.jar`) hem de isteğe bağlı Geyser uyumluluk modülünü (`AntiAFK-Geyser.jar`) içerir.
            
            **Kurulum:**
            - **Geyser kullanmıyorsanız:** İndirdiğiniz zip dosyasından sadece `AntiAFK-Core-*.jar` dosyasını `plugins` klasörünüze atın.
            - **Geyser kullanıyorsanız (ve sunucunuz Java 17+ ise):** Zip dosyasındaki **her iki JAR dosyasını da** `plugins` klasörünüze atın.
          draft: false
          prerelease: false

      - name: ZIP Arşivini Release'e Yükle
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.zip_release.outputs.ZIP_PATH }}
          asset_name: ${{ steps.zip_release.outputs.ZIP_PATH }}
          asset_content_type: application/zip

      - name: Modrinth'e Yükle
        uses: RubixDev/modrinth-upload@v1
        with:
          project_id: "ZrW0jIBC"
          token: ${{ secrets.MODRINTH_TOKEN }}
          file_path: ${{ steps.zip_release.outputs.ZIP_PATH }}
          name: "AntiAFK ${{ github.ref_name }}"
          version: ${{ github.ref_name }}
          changelog: ${{ steps.create_release.outputs.body }}
          game_versions: '["1.13.2", "1.14", "1.14.1", "1.14.2", "1.14.3", "1.14.4", "1.15", "1.15.1", "1.15.2", "1.16", "1.16.1", "1.16.2", "1.16.3", "1.16.4", "1.16.5", "1.17", "1.17.1", "1.18", "1.18.1", "1.18.2", "1.19", "1.19.1", "1.19.2", "1.19.3", "1.19.4", "1.20", "1.20.1", "1.20.2", "1.20.3", "1.20.4", "1.20.5", "1.20.6", "1.21", "1.21.1", "1.21.2", "1.21.3", "1.21.4", "1.21.5", "1.21.6", "1.21.7", "1.21.8", "1.21.9"]'
          loaders: '["paper", "spigot", "bukkit", "purpur"]'
          featured: true
          release_type: "release"