name: Java CI with Maven - Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read
      issues: read

    steps:
      - name: Kodu Checkout Yap
        uses: actions/checkout@v4

      - name: JDK 17 Kurulumu
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Maven ile TÃ¼m ModÃ¼lleri Derle (Build)
        run: mvn -B clean package

      - name: YayÄ±n VarlÄ±klarÄ±nÄ± ZIP Olarak ArÅŸivle
        id: zip_release
        run: |
          CORE_JAR=$(find AntiAFK-Core/target -name "AntiAFK-Core-*.jar" ! -name "original-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar")
          GEYSER_JAR=$(find AntiAFK-Geyser/target -name "AntiAFK-Geyser-*.jar" ! -name "original-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar")
          
          ZIP_NAME="AntiAFK-${{ github.ref_name }}.zip"
          
          zip -j $ZIP_NAME $CORE_JAR $GEYSER_JAR
          
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Changelog OluÅŸtur
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: |
            {
              "template": "# ğŸ“¦ DeÄŸiÅŸiklikler\n\n#{{CHANGELOG}}",
              "categories": [
                {
                  "title": "## ğŸš€ Yeni Ã–zellikler",
                  "labels": ["feature", "feat", "enhancement"]
                },
                {
                  "title": "## ğŸ› Hata DÃ¼zeltmeleri",
                  "labels": ["fix", "bug", "patch"]
                },
                {
                  "title": "## ğŸ› ï¸ DiÄŸer DeÄŸiÅŸiklikler",
                  "labels": []
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: GitHub Release OluÅŸtur
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            AntiAFK'nÄ±n ${{ github.ref_name }} sÃ¼rÃ¼mÃ¼ne hoÅŸ geldiniz!
            
            ${{ steps.build_changelog.outputs.changelog }}
            
            ---
            
            ### Kurulum
            Bu sÃ¼rÃ¼m, hem Java 8 destekli ana eklentiyi (`AntiAFK-Core.jar`) hem de isteÄŸe baÄŸlÄ± Geyser uyumluluk modÃ¼lÃ¼nÃ¼ (`AntiAFK-Geyser.jar`) iÃ§erir.
            
            - **Geyser kullanmÄ±yorsanÄ±z:** Ä°ndirdiÄŸiniz zip dosyasÄ±ndan sadece `AntiAFK-Core-*.jar` dosyasÄ±nÄ± `plugins` klasÃ¶rÃ¼nÃ¼ze atÄ±n.
            - **Geyser kullanÄ±yorsanÄ±z (ve sunucunuz Java 17+ ise):** Zip dosyasÄ±ndaki **her iki JAR dosyasÄ±nÄ± da** `plugins` klasÃ¶rÃ¼nÃ¼ze atÄ±n.
          files: ${{ steps.zip_release.outputs.ZIP_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Modrinth'e YÃ¼kle
        uses: RubixDev/modrinth-upload@v1
        with:
          project_id: "ZrW0jIBC"
          token: ${{ secrets.MODRINTH_TOKEN }}
          file_path: ${{ steps.zip_release.outputs.ZIP_PATH }}
          name: "AntiAFK ${{ github.ref_name }}"
          version: ${{ github.ref_name }}
          changelog: ${{ steps.build_changelog.outputs.changelog }}
          game_versions: '["1.13.2", "1.14", "1.14.1", "1.14.2", "1.14.3", "1.14.4", "1.15", "1.15.1", "1.15.2", "1.16", "1.16.1", "1.16.2", "1.16.3", "1.16.4", "1.16.5", "1.17", "1.17.1", "1.18", "1.18.1", "1.18.2", "1.19", "1.19.1", "1.19.2", "1.19.3", "1.19.4", "1.20", "1.20.1", "1.20.2", "1.20.3", "1.20.4", "1.20.5", "1.20.6", "1.21", "1.21.1", "1.21.2", "1.21.3", "1.21.4", "1.21.5", "1.21.6", "1.21.7", "1.21.8", "1.21.9"]'
          loaders: '["paper", "spigot", "bukkit", "purpur"]'
          featured: true
          release_type: "release"